<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê¸°ì‚¬ì˜ ëª¨í—˜ (Knight's Tour)</title>
<style>
  :root{
    --board-size: 5;
    --cell: 84px;
    /* í´ë˜ì‹ ì²´ìŠ¤ ì»¬ëŸ¬ (ê·¸ë¦°/íƒ„) */
    --square-dark: #769656; /* green */
    --square-light: #eeeed2; /* tan */
    --visited-shade: rgba(0,0,0,.20);
    --current-glow: 0 0 0 3px #10b981, 0 0 18px #10b98188;
    /* í•˜ì´ë¼ì´íŠ¸ëŠ” ë©´ ì±„ìš°ê¸°ë§Œ ì‚¬ìš© (í…Œë‘ë¦¬/ì„  ì—†ìŒ) */
    --legal-fill: rgba(96,165,250,.18);
    --hint1-fill: rgba(59,130,246,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
    color:#e5e7eb;
    background: radial-gradient(1200px 800px at 20% -10%, #1f2937, #0b0c10);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px
  }
  .app{width:min(100%,1100px)}
  .topbar{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:14px
  }
  .title{
    font-weight:800;
    letter-spacing:.2px;
    font-size:clamp(18px,3vw,26px)
  }
  .controls{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center
  }
  button{
    background:#111827;
    border:1px solid #262b36;
    color:#e5e7eb;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    transition:.15s transform, .15s opacity;
    font-weight:600
  }
  button:hover{transform:translateY(-1px)}
  button[disabled]{opacity:.45; cursor:not-allowed}
  .pill{
    padding:6px 10px;
    border-radius:999px;
    background:#0b1220;
    border:1px solid #233047
  }

  .board-wrap{
    display:flex;
    gap:18px;
    align-items:flex-start;
    flex-wrap:wrap
  }
  .board{
    --size: calc(var(--cell)*var(--board-size));
    width:var(--size);
    height:var(--size);
    display:grid;
    grid-template-columns:repeat(var(--board-size), var(--cell));
    grid-template-rows:repeat(var(--board-size), var(--cell));
    border-radius:16px;
    overflow:hidden;
    box-shadow:0 10px 40px #0006;
    border:2px solid #2a2f3a;
    position:relative;
    z-index:0
  }
  .square{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none
  }
  .square.light{background:var(--square-light)}
  .square.dark{background:var(--square-dark)}
  .square.visited::after{
    content:"";
    position:absolute;
    inset:0;
    background:var(--visited-shade)
  }
  .square.current{box-shadow: var(--current-glow) inset}
  /* ì´ë™ ê°€ëŠ¥: ë©´ ì±„ìš°ê¸°ë§Œ (íŒŒë€ë¹›) */
  .square.legal::after{
    content:"";
    position:absolute;
    inset:0;
    background: var(--legal-fill);
    pointer-events:none
  }
  /* íŒíŠ¸(ìµœì„  1ìˆ˜): ë” ì§„í•œ ë©´ ì±„ìš°ê¸° (ë°°ì§€ ì—†ìŒ) */
  .square.hint1::after{
    content:"";
    position:absolute;
    inset:0;
    background: var(--hint1-fill);
    pointer-events:none
  }

  .idx{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New";
    color:#111;
    mix-blend-mode:multiply;
    z-index:1;
    font-size: clamp(12px, calc(var(--cell)*0.2), 20px)
  }
  .idx.visited{color:#333; opacity:.85}

  .knight{
    position:absolute;
    z-index:2;
    font-size: clamp(30px, calc(var(--cell)*0.60), 56px);
    filter: drop-shadow(0 4px 6px rgba(0,0,0,.35))
  }

  .side{
    flex:1;
    min-width:260px;
    background:#0b1220;
    border:1px solid #1f2a44;
    border-radius:16px;
    padding:14px
  }
  .side h3{margin:.2rem 0 .6rem; font-size:16px}
  .meta{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    font-size:14px
  }
  .meta div{
    background:#0e1726;
    border:1px solid #25324a;
    padding:8px 10px;
    border-radius:10px
  }

  .toast{
    position:fixed;
    right:16px;
    bottom:16px;
    background:#0b1220;
    border:1px solid #1f2a44;
    padding:10px 12px;
    border-radius:10px;
    font-size:14px;
    opacity:0;
    transform:translateY(8px);
    transition:.2s
  }
  .toast.show{
    opacity:1;
    transform:translateY(0)
  }

  /* overlays */
  .overlay{
    position:fixed;
    inset:0;
    background: radial-gradient(1000px 700px at 30% -10%, #18212f, #090b0f);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10000;
    pointer-events:auto
  }
  .card{
    background:#0b1220;
    border:1px solid #1f2a44;
    border-radius:16px;
    padding:22px;
    width:min(92vw,560px)
  }
  .card h1{margin:0 0 8px; font-size:24px}
  .card p{margin:0 0 12px; opacity:.9}
</style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">â™ ê¸°ì‚¬ì˜ ëª¨í—˜ <span class="pill" id="stageLabel">Stage 1 Â· 5Ã—5</span></div>
      <div class="controls">
        <button id="btnStartScreen">ì´ˆê¸° í™”ë©´</button>
        <button id="btnReset">ë¦¬ì…‹</button>
        <button id="btnUndo" disabled>ë˜ëŒë¦¬ê¸°(1íšŒ)</button>
        <button id="btnHint">íŒíŠ¸(ìµœì„  1ìˆ˜)</button>
        <button id="btnNext" disabled>ë‹¤ìŒ ìŠ¤í…Œì´ì§€ â–¶</button>
      </div>
    </div>

    <div class="board-wrap">
      <div id="board" class="board" aria-label="ì²´ìŠ¤íŒ" role="grid"></div>
      <aside class="side">
        <h3>ì§„í–‰ ì •ë³´</h3>
        <div class="meta">
          <div>ë°©ë¬¸ ìˆ˜: <b id="moves">0</b></div>
          <div>ì „ì²´ ì¹¸: <b id="total">25</b></div>
          <div>ë‚¨ì€ ì¹¸: <b id="left">25</b></div>
          <div>ê²½ê³¼ ì‹œê°„: <b id="elapsed">00:00</b></div>
          <div>ìŠ¤í…Œì´ì§€: <b id="stageHuman">1 / 5</b></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Start overlay -->
  <div class="overlay" id="start">
    <div class="card">
      <h1>â™ ê¸°ì‚¬ì˜ ëª¨í—˜</h1>
      <p>ë‚˜ì´íŠ¸ì˜ ê·œì¹™ìœ¼ë¡œ ëª¨ë“  ì¹¸ì„ í•œ ë²ˆì”©ë§Œ ë°©ë¬¸í•˜ì„¸ìš”. ìŠ¤í…Œì´ì§€ëŠ” 5Ã—5 â†’ 9Ã—9 ìˆœìœ¼ë¡œ ìë™ ì§„í–‰ë©ë‹ˆë‹¤.</p>
      <button id="btnStart">ê²Œì„ ì‹œì‘</button>
    </div>
  </div>

  <!-- Final overlay -->
  <div class="overlay" id="final">
    <div class="card">
      <h1>ëª¨ë“  ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! ğŸ‰</h1>
      <p id="finalSummary">ê²°ê³¼ ìš”ì•½</p>
      <button id="btnFinalToStart">ì´ˆê¸° í™”ë©´ìœ¼ë¡œ</button>
    </div>
  </div>

  <div class="toast" id="toast">ì•ˆë‚´</div>

<script>
(function(){
  const stages=[5,6,7,8,9];
  let stageIndex=0;
  let N=stages[stageIndex];

  const boardEl=document.getElementById('board');
  const startOverlay=document.getElementById('start');
  const finalOverlay=document.getElementById('final');
  const btnStart=document.getElementById('btnStart');
  const btnStartScreen=document.getElementById('btnStartScreen');
  const btnFinalToStart=document.getElementById('btnFinalToStart');
  const btnReset=document.getElementById('btnReset');
  const btnUndo=document.getElementById('btnUndo');
  const btnHint=document.getElementById('btnHint');
  const btnNext=document.getElementById('btnNext');
  const stageLabel=document.getElementById('stageLabel');
  const movesEl=document.getElementById('moves');
  const totalEl=document.getElementById('total');
  const leftEl=document.getElementById('left');
  const stageHumanEl=document.getElementById('stageHuman');
  const elapsedEl=document.getElementById('elapsed');
  const toast=document.getElementById('toast');

  const knightMoves=[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]];

  let current=null;
  let path=[];
  let visited=[];
  let stageStart=null;
  let tickTimer=null;
  let totalMillis=0;
  const perStage=[0,0,0,0,0];
  let canUndo=false;

  // íŒíŠ¸ ì œí•œ
  const HINT_LIMIT_PER_STAGE = 5;
  let hintUsed = 0;

  // Hidden cheat
  let cheatArmed=false;
  let cheatTimer=null;

  // Helpers
  const idx=(r,c)=>r*N+c;
  const inBounds=(r,c)=>r>=0&&c>=0&&r<N&&c<N;
  const isOverlayVisible=()=>
    getComputedStyle(startOverlay).display!=='none' ||
    getComputedStyle(finalOverlay).display!=='none';

  const fmt=ms=>{
    const s=Math.floor(ms/1000);
    const m=Math.floor(s/60);
    const r=s%60;
    return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
  };
  const setVar=(k,v)=>document.documentElement.style.setProperty(k,v);

  function showToast(msg){
    toast.textContent=msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),1100);
  }

  function startTick(){
    stopTick();
    tickTimer=setInterval(()=>{
      const ms=(stageStart?Date.now()-stageStart:0)+perStage[stageIndex];
      elapsedEl.textContent=fmt(ms);
    },200);
  }

  function stopTick(){
    if(tickTimer){
      clearInterval(tickTimer);
      tickTimer=null;
    }
  }

  function computeCellPx(){
    const vh = window.innerHeight;
    const vw = window.innerWidth;
    const sideReserve = 420;
    const topReserve = 220;
    const maxBoard = Math.max(320, Math.min(vh - topReserve, vw - sideReserve));
    return Math.max(42, Math.min(88, Math.floor(maxBoard / N)));
  }

  function buildBoard(){
    boardEl.innerHTML='';
    boardEl.style.setProperty('--board-size',N);
    const cellPx=computeCellPx();
    setVar('--cell', cellPx+'px');

    visited=Array.from({length:N},()=>Array(N).fill(0));
    current=null;
    path=[];
    canUndo=false;
    updateHUD();

    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const sq=document.createElement('div');
        sq.className='square '+(((r+c)%2===0)?'light':'dark');
        sq.dataset.r=r;
        sq.dataset.c=c;

        const span=document.createElement('div');
        span.className='idx';
        sq.appendChild(span);

        sq.addEventListener('click', onSquareClick, {passive:true});
        boardEl.appendChild(sq);
      }
    }
  }

  function clearDecor(){
    for(const sq of boardEl.children){
      sq.classList.remove('visited','current','legal','hint1');
      const span=sq.querySelector('.idx');
      if(span){
        span.classList.remove('visited');
        span.textContent='';
      }
      const k=sq.querySelector('.knight');
      if(k) k.remove();

      // ì˜ˆì „ íŒíŠ¸ ë°°ì§€ ì œê±°ìš© (ì§€ê¸ˆì€ ìƒì„± ì•ˆ í•¨, ë°©ì–´ìš©)
      const badges=sq.querySelectorAll('.hint-badge');
      badges.forEach(b=>b.remove());
    }
  }

  function render(){
    clearDecor();

    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const n=visited[r][c];
        if(n>0){
          const sq=boardEl.children[idx(r,c)];
          sq.classList.add('visited');
          const sp=sq.querySelector('.idx');
          sp.textContent=n;
          sp.classList.add('visited');
        }
      }
    }

    if(current){
      const sq=boardEl.children[idx(current.r,current.c)];
      sq.classList.add('current');
      const k=document.createElement('div');
      k.className='knight';
      k.textContent='â™';
      sq.appendChild(k);

      for(const [dr,dc] of knightMoves){
        const nr=current.r+dr;
        const nc=current.c+dc;
        if(inBounds(nr,nc) && !visited[nr][nc]){
          boardEl.children[idx(nr,nc)].classList.add('legal');
        }
      }
    }
    updateHUD();
  }

  function onSquareClick(e){
    if(isOverlayVisible()) return;

    const r=+e.currentTarget.dataset.r;
    const c=+e.currentTarget.dataset.c;

    // ì²« í´ë¦­: ì‹œì‘ ì¹¸ ì„ íƒ
    if(!current){
      current={r,c};
      visited[r][c]=1;
      path=[{r,c}];
      canUndo=true;

      if(!stageStart){
        stageStart=Date.now();
        startTick();
      }
      render();
      return;
    }

    const legal=knightMoves.some(([dr,dc])=> current.r+dr===r && current.c+dc===c);
    if(!legal || visited[r][c]) return;

    current={r,c};
    visited[r][c]=path.length+1;
    path.push({r,c});
    canUndo=true;
    render();

    if(path.length===N*N){
      const spent=(stageStart?Date.now()-stageStart:0);
      perStage[stageIndex]+=spent;
      totalMillis+=spent;
      stageStart=null;
      stopTick();
      elapsedEl.textContent=fmt(perStage[stageIndex]);
      showToast(`Stage ${stageIndex+1} í´ë¦¬ì–´!`);
      btnNext.disabled=false;
      canUndo=false;
      updateHUD();
    }
  }

  function updateHUD(){
    movesEl.textContent=path.length;
    totalEl.textContent=N*N;
    leftEl.textContent=N*N-path.length;
    stageHumanEl.textContent=`${stageIndex+1} / ${stages.length}`;
    stageLabel.textContent=`Stage ${stageIndex+1} Â· ${N}Ã—${N}`;

    btnNext.disabled = (path.length!==N*N);
    btnUndo.disabled = !canUndo || path.length===0;
  }

  function newGame(){
    buildBoard();
    render();
    stageStart=null;
    stopTick();
    elapsedEl.textContent='00:00';

    // íŒíŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
    hintUsed = 0;
    btnHint.disabled = false;
  }

  function resetStage(){
    buildBoard();
    render();

    // ë¦¬ì…‹ ì‹œ íŒíŠ¸ë„ ë‹¤ì‹œ 0/5
    hintUsed = 0;
    btnHint.disabled = false;
  }

  function undo(){
    if(!canUndo || path.length===0) return;

    if(path.length===1){
      visited[path[0].r][path[0].c]=0;
      path=[];
      current=null;
      canUndo=false;
      render();
      return;
    }
    const last=path.pop();
    visited[last.r][last.c]=0;
    current=path[path.length-1] || null;
    canUndo=false;
    render();
  }

  // Hint: ìµœì„  1ìˆ˜ (ë©´ ê°•ì¡°ë§Œ, ë°°ì§€ ì—†ìŒ) + ìŠ¤í…Œì´ì§€ë‹¹ 5íšŒ ì œí•œ
  function degree(r,c){
    let d=0;
    for(const [dr,dc] of knightMoves){
      const nr=r+dr, nc=c+dc;
      if(inBounds(nr,nc) && !visited[nr][nc]) d++;
    }
    return d;
  }

  function sortedCandidates(r,c){
    const out=[];
    for(const [dr,dc] of knightMoves){
      const nr=r+dr,nc=c+dc;
      if(inBounds(nr,nc) && !visited[nr][nc]){
        out.push({r:nr,c:nc,deg:degree(nr,nc)});
      }
    }
    out.sort((a,b)=>a.deg-b.deg || Math.random()-0.5);
    return out;
  }

  function showBest1(){
    if(!current){
      showToast('ì‹œì‘ ì¹¸ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
      return;
    }

    // íŒíŠ¸ 5íšŒ ì œí•œ
    if(hintUsed >= HINT_LIMIT_PER_STAGE){
      btnHint.disabled = true;
      showToast('ì´ë²ˆ ìŠ¤í…Œì´ì§€ì—ì„œ íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”');
      return;
    }

    // ê¸°ì¡´ íŒíŠ¸ í”ì  ì œê±°
    for(const sq of boardEl.children){
      sq.classList.remove('hint1');
      const hb=sq.querySelector('.hint-badge');
      if(hb) hb.remove();
    }

    const cs=sortedCandidates(current.r,current.c).slice(0,1);
    if(!cs.length){
      showToast('ê°€ëŠ¥í•œ ìˆ˜ê°€ ì—†ì–´ìš”');
      return;
    }

    const p=cs[0];
    const sq=boardEl.children[idx(p.r,p.c)];
    sq.classList.add('hint1'); // ìµœì„  1ìˆ˜ë§Œ ì§„í•˜ê²Œ ë©´ ì±„ìš°ê¸°

    hintUsed++;
    if(hintUsed >= HINT_LIMIT_PER_STAGE){
      btnHint.disabled = true;
      showToast('ì´ë²ˆ ìŠ¤í…Œì´ì§€ íŒíŠ¸(5íšŒ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”');
    } else {
      showToast(`íŒíŠ¸ ì‚¬ìš©: ${hintUsed}/${HINT_LIMIT_PER_STAGE}`);
    }
  }

  // Hidden autocomplete (cheat)
  function warnsdorffSolve(start){
    let cur=start || {r:0,c:0};
    if(!start){
      visited[cur.r][cur.c]=1;
      path=[{...cur}];
    }
    const deg=(r,c)=>{
      let d=0;
      for(const[dr,dc]of knightMoves){
        const nr=r+dr,nc=c+dc;
        if(inBounds(nr,nc)&&!visited[nr][nc]) d++;
      }
      return d;
    };
    while(path.length<N*N){
      let cand=[];
      for(const[dr,dc]of knightMoves){
        const nr=cur.r+dr,nc=cur.c+dc;
        if(inBounds(nr,nc)&&!visited[nr][nc]){
          cand.push({r:nr,c:nc,deg:deg(nr,nc)});
        }
      }
      if(!cand.length) return false;
      cand.sort((a,b)=>a.deg-b.deg || Math.random()-0.5);
      const nxt=cand[0];
      cur={r:nxt.r,c:nxt.c};
      visited[cur.r][cur.c]=path.length+1;
      path.push({...cur});
    }
    current={...path[path.length-1]};
    return true;
  }

  function autoComplete(){
    if(!current){
      current={r:(N%2?Math.floor(N/2):1), c:(N%2?0:1)};
      visited[current.r][current.c]=1;
      path=[{...current}];
    }
    const snap=visited.map(r=>r.slice());
    const start={...current};

    for(let t=0;t<120;t++){
      for(let r=0;r<N;r++){
        for(let c=0;c<N;c++){
          visited[r][c]=snap[r][c];
        }
      }
      path=[{...start}];
      current={...start};
      knightMoves.sort(()=>Math.random()-0.5);
      const ok=warnsdorffSolve(start);
      if(ok){
        render();
        return true;
      }
    }
    render();
    return false;
  }

  // Stage nav & final
  function toStartScreen(){
    finalOverlay.style.display='none';
    startOverlay.style.display='flex';
    stageIndex=0;
    N=stages[0];
    totalMillis=0;
    for(let i=0;i<perStage.length;i++) perStage[i]=0;
    newGame();
  }

  function nextStage(){
    if(stageIndex<stages.length-1){
      stageIndex++;
      N=stages[stageIndex];
      newGame();
    } else {
      showFinal();
    }
  }

  function prevStage(){
    if(stageIndex>0){
      stageIndex--;
      N=stages[stageIndex];
      newGame();
    }
  }

  function showFinal(){
    let html=`<b>ì´ ì†Œìš” ì‹œê°„:</b> ${fmt(totalMillis)}<br><br>`;
    html+='<b>ìŠ¤í…Œì´ì§€ë³„ ê¸°ë¡</b><br>';
    stages.forEach((sz,i)=>{
      html+=`Stage ${i+1} (${sz}Ã—${sz}) â€” ${fmt(perStage[i])}<br>`;
    });
    document.getElementById('finalSummary').innerHTML=html;
    finalOverlay.style.display='flex';
  }

  // Buttons
  btnReset.addEventListener('click', resetStage);
  btnUndo.addEventListener('click', undo);
  btnHint.addEventListener('click', showBest1);
  btnNext.addEventListener('click', ()=>{
    if(path.length===N*N) nextStage();
  });

  // Start buttons
  btnStart.addEventListener('pointerdown', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
  });
  btnStart.addEventListener('click', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
    requestAnimationFrame(()=>{
      startOverlay.style.display='none';
      newGame();
    });
  });

  btnStartScreen.addEventListener('pointerdown', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
  });
  btnStartScreen.addEventListener('click', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
    toStartScreen();
  });

  btnFinalToStart.addEventListener('pointerdown', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
  });
  btnFinalToStart.addEventListener('click', (ev)=>{
    ev.preventDefault();
    ev.stopPropagation();
    toStartScreen();
  });

  // Keyboard cheats
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Backquote'){
      cheatArmed=true;
      clearTimeout(cheatTimer);
      cheatTimer=setTimeout(()=>cheatArmed=false,1500);
    }
    else if(e.key==='Enter' && cheatArmed){
      cheatArmed=false;
      clearTimeout(cheatTimer);
      setTimeout(()=>{
        const ok=autoComplete();
        if(!ok) showToast('ìë™ì™„ì„± ì‹¤íŒ¨');
      },20);
    }
    else if(e.key==='ArrowRight'){
      nextStage();
    }
    else if(e.key==='ArrowLeft'){
      prevStage();
    }
    else if(e.key==='Escape'){
      toStartScreen();
    }
  }, {passive:true});

  window.addEventListener('resize', ()=>{
    const cellPx=computeCellPx();
    setVar('--cell', cellPx+'px');
    render();
  }, {passive:true});

  startOverlay.style.display='flex';
  newGame();
})();
</script>
</body>
</html>
